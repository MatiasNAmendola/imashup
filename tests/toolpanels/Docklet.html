<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>iMashup PropertiesEditor Test</title>
  <style type="text/css">
    @import "../../../dojo/resources/dojo.css";
    @import "../../../dijit/themes/tundra/tundra.css";
    @import "../../../dijit/themes/dijit.css";
    
	@import "../../toolpanels/templates/Docklet.css";

	@import "../../../dojox/layout/resources/FloatingPane.css"; 
	@import "../../../dojox/layout/resources/ResizeHandle.css"; 

  </style>

  <script type="text/javascript" src="../../../dojo/dojo.js" djConfig="isDebug:true, parseOnLoad: true"></script>
  <script type="text/javascript">
    dojo.require("imashup.toolpanels.PropertiesEditor");
    dojo.require("imashup.toolpanels.Desktop");
    dojo.require("imashup.toolpanels.Docklet");
    dojo.require("doh.runner");

    dojo.addOnLoad(function(){
        doh.register("t",
           [
           	  function test_conn(t){
           	  	var d=dijit.byId("docklet1");
           	  	dojo.connect(d,"setup",function(){
           	  		dijit.byId("pe").setFocusWidget(dijit.byId('docklet1'));
           	  	})//zq pls make this universal
           	  },
           	  function test_docklet_init(t){
           	    //INITIALIZATION CHECK
           	    var d = dijit.byId("docklet1");
           	  	t.is(d.componentTypeEnumeration.length,0);
           	  },
           	  function test_docklet_update(t){
           	  	//ORDINARY UPDATE
           	  	var d = dijit.byId("docklet1");
           	  	d.updateComponentTypeEnumeration();
           	  	t.is(d.componentTypeEnumeration.length,2);
           	  	//DYNAMIC UPDATE, SHOULD BE CAPABLE TO FIND NEWLY-ADDED CLASS
                dojo.declare("im", dijit._Widget, {});
                var option = {
                    impl_name : 'im',
                    interface: {
                        properties: {i:{type:'string'}, j:{type:'string'}},
                        methods: {},
                        events: {}
                    }
                };
                var ctm = imashup.core.componentTypeManager;
                ctm.registerComponentType(option);
                d.updateComponentTypeEnumeration();
                t.is(d.componentTypeEnumeration.length,3);
                //CORRECTNESS CHECKING
                dojo.forEach(d.componentTypeEnumeration, function(i){
                	t.f(i.flag);
                	t.is(i.pNode,null);
                })
           	  },
           	  function test_docklet_get(t){
           	  	var d = dijit.byId("docklet1");
           	  	var original = {
           	  		"template": {
           	  			"imashup_toolpanels_Desktop": {
           	  				"dojoType": "dijit.form.CheckBox", 
           	  				"value": "on"
           	  			}, 
           	  			"imashup_toolpanels_Docklet": {
           	  				"dojoType": "dijit.form.CheckBox", 
           	  				"value": "on"
           	  			}, 
           	  			"im": {
           	  				"dojoType": "dijit.form.CheckBox", 
           	  				"value": "on"
           	  			}
           	  		}, 
           	  		"data": {
           	  			"imashup_toolpanels_Desktop": [
           	  			], 
           	  			"imashup_toolpanels_Docklet": [
           	  			], 
           	  			"im": [
           	  			]
           	  		}
           	  	}
           	  	
           	  	t.is(d.getComponentTypeEnumeration(), dojo.toJson(original,true))
           	  },
           	  function test_docklet_set(t){
           	  	var data = {
       	  			"imashup_toolpanels_Desktop": [], 
       	  			"imashup_toolpanels_Docklet": ["on"], 
       	  			"im": []
           	  	}
           	  	
           	  	var d = dijit.byId("docklet1");
           	  	d.setComponentTypeEnumeration(data);
           	  	//CHECK ITEM IN MARKUP
           	  	t.is(d.dockTable.getDescendants().length,1);
           	  	//CHECK ITEM IN DATA STRUCTRUE
           	  	var due=[];
           	  	dojo.forEach(d.componentTypeEnumeration,function(i){
           	  		if(i.name == "imashup.toolpanels.Docklet"){
           	  			t.t(i.flag);
           	  			t.f(i.pNode==null);
           	  			due.push(i);
           	  		}
           	  		else{
           	  			t.f(i.flag);
           	  			t.is(i.pNode,null);
           	  		}
           	  	})
           	  	//CHECK NO DUPLICATION ALLOWED
           	  	t.is(due.length,1);
           	  },
           	  
           	  //CAUTION! THIS COULD TAKE QUITE A WHILE!
           	  function test_docklet_crazy_ADD_REMOVE(t){
           	  	if(!confirm("Wanna something hot:) ???")) return;
           	  	
           	  	console.log("CAUTION! THIS COULD TAKE QUITE A WHILE!");
           	  	var d = dijit.byId("docklet1");
				var option1 = {
       	  			"imashup_toolpanels_Desktop": [], 
       	  			"imashup_toolpanels_Docklet": ["on"], 
       	  			"im": []
           	  	};
				var anti_option1 = {
       	  			"imashup_toolpanels_Desktop": ["on"], 
       	  			"imashup_toolpanels_Docklet": [], 
       	  			"im": ["on"]
           	  	};
           	  	//CHECK REPEAT ADDING ACTION
				d.setComponentTypeEnumeration(option1);
				d.setComponentTypeEnumeration(option1);
           	  	dojo.forEach(d.componentTypeEnumeration,function(i){
           	  		if(i.name == "imashup.toolpanels.Docklet"){
           	  			t.t(i.flag);
           	  			t.f(i.pNode==null);
           	  		}
           	  		else{
           	  			t.f(i.flag);
           	  			t.is(i.pNode,null);
           	  		}
           	  	})
           	  	//CHECK REPEAT REMOVING ACTION
           	 	d.setComponentTypeEnumeration(anti_option1);
           	 	d.setComponentTypeEnumeration(anti_option1);
           	  	dojo.forEach(d.componentTypeEnumeration,function(i){
           	  		if(i.name == "imashup.toolpanels.Docklet"){
           	  			t.f(i.flag);
           	  			t.t(i.pNode==null);
           	  		}
           	  		else if(i.name == "imashup.toolpanels.Desktop"){
           	  			t.t(i.flag);
           	  			t.f(i.pNode==null);
           	  		}else{ //im is a fake class with NO icons, so it failed to establish
           	  			t.f(i.flag);
           	  			t.t(i.pNode==null);
           	  		}
           	  	})
           	  	//CRAZY CHECK
           	  	for (var meaningless=0;meaningless<20;meaningless++){
					d.setComponentTypeEnumeration(option1);
	           	 	d.setComponentTypeEnumeration(anti_option1);
           	  	}
           	  	dojo.forEach(d.componentTypeEnumeration,function(i){
           	  		if(i.name == "imashup.toolpanels.Docklet"){
           	  			t.f(i.flag);
           	  			t.t(i.pNode==null);
           	  		}
           	  		else if(i.name == "imashup.toolpanels.Desktop"){
           	  			t.t(i.flag);
           	  			t.f(i.pNode==null);
           	  		}else{ //im is a fake class with NO icons, so it failed to establish
           	  			t.f(i.flag);
           	  			t.t(i.pNode==null);
           	  		}
           	  	})
           	  },
           	  function test_docklet_imageLoading(t){
           	  	var d = dijit.byId("docklet1");
				var option = {
       	  			"imashup_toolpanels_Desktop": [], 
       	  			"imashup_toolpanels_Docklet": ["on"], 
       	  			"im": []
           	  	};
           	  	//CHECK REPEAT ADDING ACTION
				d.setComponentTypeEnumeration(option);
				d.launchItem("imashup.toolpanels.Docklet");
				for (i = 0;i < d.componentTypeEnumeration.length;i++){
					var o = d.componentTypeEnumeration[i];
					if (o.name == "imashup.toolpanels.Docklet"){
						t.is(o.pNode.domNode.className,"dojoxFisheyeListItemLaunched");
					}
        		}
        		
        		d.closeItem("imashup.toolpanels.Docklet");
				for (i = 0;i < d.componentTypeEnumeration.length;i++){
					var o = d.componentTypeEnumeration[i];
					if (o.name == "imashup.toolpanels.Docklet"){
						t.is(o.pNode.domNode.className,"dojoxFisheyeListItem");
					}
        		}
        		d.closeItem("imashup.toolpanels.Docklet");
        		d.removeItem("imashup.toolpanels.Docklet");
           	  },
           	  function test_docklet_launch(t){
           	  	console.log("PLS ZQ FIX ME!!!!!!!!!!!!!!!!!!!")
           	  }
           ]
        );
        doh.run();
        
    });
  </script>
</head>
<body class="tundra">
  <div id="docklet1" dojoType="imashup.toolpanels.Docklet"></div>
  <div id='pe' dojoType="imashup.toolpanels.PropertiesEditor" />
</body>
</html>
